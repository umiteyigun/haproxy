global
    log stdout local0
    maxconn 4096
    user haproxy
    group haproxy
    daemon
    # stats socket /var/run/haproxy/haproxy.sock mode 666 level admin
    # stats timeout 2m
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option forwardfor
    option http-server-close
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    timeout http-request 10s
    timeout http-keep-alive 10s

# Frontend for HTTP (port 80)
frontend http_frontend
    bind *:80
    # Allow Let's Encrypt validation
    acl letsencrypt-acl path_beg /.well-known/acme-challenge/

    filter spoe engine modsecurity config /usr/local/etc/haproxy/modsecurity.conf

    # --- WAF: IP blacklist, rate limiting, and bad user-agent filtering ---
    stick-table type ip size 100k expire 10m store http_req_rate(10s)
    acl waf_blacklisted_ip src -f /usr/local/etc/haproxy/config.d/ip_blacklist.lst
    http-request track-sc0 src if !letsencrypt-acl
    acl waf_rate_abuse sc_http_req_rate(0) gt 100
    acl waf_bad_user_agent hdr_sub(User-Agent) -f /usr/local/etc/haproxy/maps/bad_useragents.lst
    http-request deny deny_status 403 if waf_blacklisted_ip !letsencrypt-acl
    http-request deny deny_status 429 if waf_rate_abuse !letsencrypt-acl
    http-request deny deny_status 403 if waf_bad_user_agent !letsencrypt-acl

    # Dynamic host-based routing (generated by API)
    acl host_1 hdr(host) -i ssl.trtek.tr

    http-request redirect scheme https code 301 if host_1

    use_backend backend_1 if host_1

    use_backend web_backend if letsencrypt-acl
    default_backend web_backend

# Frontend for HTTPS (port 443)
frontend https_frontend
    bind *:443 ssl crt /etc/ssl/certs/haproxy/trtek.tr.pem

    option forwardfor
    http-request set-header X-Forwarded-Proto https
    acl letsencrypt-acl path_beg /.well-known/acme-challenge/

    filter spoe engine modsecurity config /usr/local/etc/haproxy/modsecurity.conf

    stick-table type ip size 100k expire 10m store http_req_rate(10s)
    acl waf_blacklisted_ip src -f /usr/local/etc/haproxy/config.d/ip_blacklist.lst
    http-request track-sc0 src
    acl waf_rate_abuse sc_http_req_rate(0) gt 100
    acl waf_bad_user_agent hdr_sub(User-Agent) -f /usr/local/etc/haproxy/maps/bad_useragents.lst
    http-request deny deny_status 403 if waf_blacklisted_ip
    http-request deny deny_status 429 if waf_rate_abuse
    http-request deny deny_status 403 if waf_bad_user_agent

    # Dynamic host-based routing (generated by API)
    acl host_1 hdr(host) -i ssl.trtek.tr

    use_backend backend_1 if host_1

    use_backend web_backend if letsencrypt-acl
    default_backend web_backend

# Backend for Web UI and Let's Encrypt validation (using busybox httpd instead of nginx)
backend web_backend
    server web haproxy-web:80

# Dynamic backends (generated by API)
backend backend_1
    server deneme_1 192.168.200.207:80 check inter 3s fall 3 rise 2
    server deneme_2 192.168.200.208:80 check inter 3s fall 3 rise 2 backup



# SPOE backend for ModSecurity agent
backend spoa
    mode tcp
    timeout connect 5s
    timeout server 5m
    server modsecurity-agent haproxy-spoa:12345

# HAProxy Stats
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    http-request allow
    http-request deny
