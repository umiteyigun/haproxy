global
    log stdout local0
    maxconn 4096
    user haproxy
    group haproxy
    daemon
    # stats socket /var/run/haproxy/haproxy.sock mode 666 level admin
    # stats timeout 2m
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option forwardfor
    option http-server-close
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    timeout http-request 10s
    timeout http-keep-alive 10s

# Frontend for HTTP (port 80)
frontend http_frontend
    bind *:80
    # Allow Let's Encrypt validation
    acl letsencrypt-acl path_beg /.well-known/acme-challenge/
    use_backend web_backend if letsencrypt-acl

    # Dynamic host-based routing (generated by API)
    acl host_1 hdr(host) -i ssl.trtek.tr

    http-request redirect scheme https code 301 if host_1

    use_backend backend_1 if host_1

    default_backend web_backend

# Frontend for HTTPS (port 443)
frontend https_frontend
    bind *:443 ssl crt /etc/ssl/certs/haproxy/trtek.tr.pem

    option forwardfor
    http-request set-header X-Forwarded-Proto https
    # Dynamic host-based routing (generated by API)
    acl host_1 hdr(host) -i ssl.trtek.tr

    use_backend backend_1 if host_1

    default_backend web_backend

# Backend for Web UI and Let's Encrypt validation (using busybox httpd instead of nginx)
backend web_backend
    server web haproxy-web:80

# Dynamic backends (generated by API)
backend backend_1
    server deneme_1 192.168.200.207:80 check inter 3s fall 3 rise 2
    server deneme_2 192.168.200.208:80 check inter 3s fall 3 rise 2 backup



# HAProxy Stats
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    http-request allow
    http-request deny
